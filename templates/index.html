<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ramzy</title>
  <style>

    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f7f7f7;
        position: relative;
    }

    #logo {
        position: absolute;
        top: 10px;
        left: 10px;
        max-width: 100px;
        width: auto;
        height: auto;
        display: block;
    }

    #container {
        display: flex;
        width: 80%;
        height: 100vh;
        justify-content: center;
        transition: all 0.8s ease;
    }

    #chat-container {
        width: 80%;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        height: 97.4%;
        padding: 8px;
        transition: width 0.8s ease;
        position: relative; /* keep this */
    }

    #chat-box {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        border-bottom: 2px solid #ccc;
        background-color: #f9f9f9;
        margin-bottom: 10px;
    }

    .message {
        padding: 8px 12px;
        margin: 6px 0;
        border-radius: 10px;
        max-width: 80%;
    }

    .user-message {
        background-color: #e1f5fe;
        text-align: right;
        margin-left: auto;
    }

    .bot-message {
        background-color: #f1f1f1;
        text-align: left;
        margin-right: auto;
    }

    .greeting-message {
        color: #666;
        font-style: italic;
    }

    .input-container {
        display: flex;
        justify-content: space-between;
        padding: 1px;
        background-color: #fff;
    }

    #user-input {
        width: 85%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 20px;
        font-size: 14px;
    }

    #send-button {
        width: 12%;
        padding: 10px;
        background-color: #4797ed;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
    }

    #send-button:hover {
        background-color: #0056b3;
    }

    #service-buttons,
    .sub-service-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    #service-buttons button,
    .sub-service-buttons button {
        padding: 10px 15px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 20px;
        cursor: pointer;
        background-color: #e1f5fe;
        transition: background-color 0.8s;
    }

    #service-buttons button:hover,
    .sub-service-buttons button:hover {
        background-color: #b3e5fc;
    }

    #breadcrumbs {
        margin: 10px;
        font-size: 14px;
        color: #666;
        width: calc(100% - 250px);  /* Increased space for both buttons */
        word-wrap: break-word;
        line-height: 1.5;
        display: block;
    }

    #breadcrumbs a {
        color: #007bff;
        text-decoration: none;
        margin-right: 5px;
        display: inline-block;  /* Keep for better wrapping */
        max-width: 100%;  /* Ensure links wrap within container */
    }

    #breadcrumbs a:hover {
        text-decoration: underline;
    }

    /* Adjusting iframe container */
    #iframe-container {
        display: none;          /* Hidden by default */
        flex: 0 0 50%;          /* Takes 40% of the width */
        height: 100%;           /* Matches parent container height */
        background-color: white;
        border-left: 2px solid #ccc;
        box-sizing: border-box;
        transition: all 0.8s ;      /* Remove unintended animations */
    }

    /* When iframe is active */
    .chat-with-iframe #iframe-container {
        display: block;         /* Make the iframe container visible */
    }

    /* Ensure iframe always fills its container */
    #iframe-container iframe {
        width: 100%;
        height: 99%;
        border: none;
    }

    /* Chat container width adjustment */
    .chat-with-iframe #chat-container {
        flex: 0 0 50%;          /* Reduce width when iframe is shown */
    }

    /* Force chat container to be 60% and iframe container 40% side by side */
    #container.chat-with-iframe #chat-container {
        width: 50% !important;
        margin-right: 0 !important;       /* remove any leftover margins if needed */
    }

    #container.chat-with-iframe #iframe-container {
        display: block !important;        /* ensure iframe is shown */
        position: relative !important;    /* override absolute positioning */
        width: 50% !important;
        height: auto !important;          /* let it size automatically */
        margin-left: 10px !important;     /* some spacing from chat container */
        top: auto !important;
        right: auto !important;
    }

    .clear-history-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }

    .clear-btn {
        background-color: #ff4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .clear-btn:hover {
        background-color: #cc0000;
    }

    /* Add these new styles for message formatting */
    .message {
        padding: 12px 16px;
        margin: 6px 0;
        border-radius: 10px;
        max-width: 80%;
        white-space: pre-wrap;  /* Preserves formatting */
        line-height: 1.5;
    }

    /* Style markdown-like elements */
    .bot-message h3 {
        margin: 12px 0;
        font-size: 1.2em;
        color: #2c3e50;
        font-weight: bold;
    }

    .bot-message h2 {
        margin: 15px 0;
        font-size: 1.5em;
        color: #2c3e50;
        font-weight: bold;
    }

    .bot-message strong,
    .bot-message b {
        color: #2c3e50;
        font-weight: bold;
    }

    .bot-message ul,
    .bot-message ol {
        margin: 10px 0;
        padding-left: 20px;
    }

    .bot-message li {
        margin: 5px 0;
        line-height: 1.6;
        color: #555;
    }

    /* Style for bullet points and lists */
    .bot-message ul {
        list-style-type: disc;
    }

    /* Style for horizontal rules */
    .bot-message hr,
    .custom-divider {
        border: 0;
        border-top: 1px solid #ccc;
        margin: 20px 0;
    }

    /* Style for # (heading) */
    .hash-heading {
        font-size: 1.8em;
        font-weight: bold;
        margin: 25px 0 15px;
        color: #333;
        line-height: 1.4;
    }


    /* Add these new styles for the logout button */
    .logout-container {
        position: absolute;
        top: 10px;
        right: 120px;  /* Position to the left of clear button */
        z-index: 1000;
    }

    .logout-btn {
        background-color: #ff4444;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .logout-btn:hover {
        background-color: #cc0000;
    }
     /* Add these new styles for the loading animation */
     .loading-container {
        display: none;
        text-align: left;
        margin: 10px 0;
    }

    .loading-dots {
        display: inline-block;
        position: relative;
        width: 60px;
        height: 20px;
    }

    .loading-dots div {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #4797ed;
        animation-timing-function: cubic-bezier(0, 1, 1, 0);
    }

    .loading-dots div:nth-child(1) {
        left: 6px;
        animation: loading1 0.6s infinite;
    }

    .loading-dots div:nth-child(2) {
        left: 6px;
        animation: loading2 0.6s infinite;
    }

    .loading-dots div:nth-child(3) {
        left: 26px;
        animation: loading2 0.6s infinite;
    }

    .loading-dots div:nth-child(4) {
        left: 45px;
        animation: loading3 0.6s infinite;
    }

    @keyframes loading1 {
        0% { transform: scale(0); }
        100% { transform: scale(1); }
    }

    @keyframes loading2 {
        0% { transform: translate(0, 0); }
        100% { transform: translate(19px, 0); }
    }

    @keyframes loading3 {
        0% { transform: scale(1); }
        100% { transform: scale(0); }
    }

    /* Add these media queries at the end of your style section */
    @media screen and (max-width: 768px) {
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            overflow: hidden;
        }

        #chat-container {
            width: 100%;
            height: 100%;
            padding: 5px;
            padding-top: 45px;  /* Reduced from 85px */
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #chat-box {
            flex: 1;
            padding: 10px;
            padding-bottom: 120px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: absolute;
            top: 45px;  /* Reduced from 85px to match container padding-top */
            bottom: 60px;
            left: 0;
            right: 0;
            margin-bottom: 0;
        }

        /* Ensure last message and buttons have enough space */
        .message:last-child,
        #service-buttons,
        .sub-service-buttons {
            margin-bottom: 80px;  /* Increased margin */
        }

        /* Ensure buttons in the greeting are fully visible */
        #greeting {
            padding-bottom: 80px;  /* Added padding for greeting section */
        }

        .input-container {
            padding: 8px 8px;  /* Reduced padding */
            background-color: #fff;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            height: 60px;
            display: flex;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            box-sizing: border-box;  /* Added to include padding in width calculation */
        }

        /* Header elements */
        #breadcrumbs {
            position: fixed;
            top: 5px;
            left: 10px;
            margin-top: 0;
            width: calc(100% - 160px);  /* Space for buttons */
            font-size: 12px;
            z-index: 1000;
            white-space: normal;  /* Changed from nowrap to allow wrapping */
            line-height: 1.5;
            display: block;
            word-wrap: break-word;
            max-height: 40px;  /* Limit to roughly 2 lines */
            overflow-y: auto;  /* Allow scrolling if more than 2 lines */
        }

        #breadcrumbs a {
            display: inline-block;  /* Allow links to wrap properly */
            margin-right: 5px;
            white-space: normal;  /* Allow text wrapping within links */
        }

        /* Adjust chat box top position for wrapped breadcrumbs */
        #chat-box {
            top: 50px;  /* Slightly increased to accommodate possible second line */
        }

        #chat-container {
            padding-top: 50px;  /* Adjusted to match */
        }

        .logout-container {
            position: fixed;
            top: 5px;  /* Reduced from 10px */
            right: 70px;
            z-index: 1000;
        }

        .clear-history-container {
            position: fixed;
            top: 5px;  /* Reduced from 10px */
            right: 10px;
            z-index: 1000;
        }

        /* Input elements */
        #user-input {
            width: 75%;  /* Reduced width */
            height: 35px;
            padding: 5px 10px;
            margin-right: 5px;  /* Reduced margin */
        }

        #send-button {
            width: 23%;  /* Increased width */
            height: 35px;
            padding: 5px;
            min-width: unset;  /* Removed minimum width constraint */
        }

        /* Message styling */
        .message {
            max-width: 90%;
            padding: 8px 10px;
            margin-bottom: 8px;  /* Increased margin between messages */
        }

        /* Ensure last message has enough space */
        .message:last-child {
            margin-bottom: 60px;  /* Match input container height */
        }

        /* Adjust button sizes to fit side by side */
        .logout-btn, .clear-btn {
            padding: 6px 10px;  /* Slightly reduced padding */
            font-size: 12px;
            height: 28px;  /* Fixed height */
        }

        /* Adjust breadcrumbs width to account for both buttons */
        #breadcrumbs {
            width: calc(100% - 160px);  /* Increased space for buttons */
        }
    }

    /* Additional adjustments for iOS */
    @supports (-webkit-touch-callout: none) {
        #chat-box {
            /* iOS-specific scrolling fixes */
            -webkit-overflow-scrolling: touch;
        }
    }

    /* Additional adjustments for very small screens */
    @media screen and (max-height: 600px) {
        #chat-box {
            padding-bottom: 60px;
        }

        .input-container {
            height: 60px;
        }

        #user-input,
        #send-button {
            height: 30px;
        }
    }

    /* Add styles for even smaller screens */
    @media screen and (max-width: 480px) {
        #service-buttons button,
        .sub-service-buttons button {
            min-width: 100%;  /* One button per row */
            margin: 2px 0;
        }

        .message {
            max-width: 95%;
            font-size: 14px;
        }

        #user-input {
            width: 70%;
        }

        #send-button {
            width: 25%;
        }

        #breadcrumbs {
            width: calc(100% - 110px);  /* Slightly adjust width for smaller screens */
            font-size: 11px;
        }

        .logout-btn,
        .clear-btn {
            padding: 4px 8px;
            font-size: 11px;
        }
    }

    /* Add styles for landscape orientation */
    @media screen and (max-height: 480px) and (orientation: landscape) {
        #chat-container {
            height: 90vh;
        }

        #chat-box {
            max-height: 60vh;
        }

        #service-buttons,
        .sub-service-buttons {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        #service-buttons button,
        .sub-service-buttons button {
            flex: 0 0 auto;
            margin: 0 5px;
            white-space: nowrap;
        }
    }

    .error-message {
        background-color: #ffebee !important;
        color: #c62828;
        border-left: 4px solid #c62828;
        padding-left: 15px;
    }
  </style>
</head>
<body>
    <img id="logo" src="{{ url_for('static', filename='logo.jpg') }}" alt="Logo">
    <!-- Add the logout button container -->
    <div class="logout-container">
        <button onclick="handleLogout()" class="logout-btn">Logout</button>
    </div>
    <div id="container">
        <div id="chat-container">
            <div id="breadcrumbs"></div>
            <div id="chat-box">
                <div id="greeting" class="greeting-message">
                    <p>Hi I am Ramzy! Please pick one of the following services or ask me any question:</p>
                    <div id="service-buttons">
                        <button onclick="handleServiceClick('Accounting')">Accounting</button>
                        <button onclick="handleServiceClick('Purchasing')">Purchasing</button>
                        <button onclick="handleServiceClick('Selling')">Selling</button>
                        <button onclick="handleServiceClick('CRM')">CRM</button>
                        <button onclick="handleServiceClick('Payroll')">Payroll</button>
                        <button onclick="handleServiceClick('Stock')">Stock</button>
                        <button onclick="handleServiceClick('Manufacturing')">Manufacturing</button>
                        <button onclick="handleServiceClick('HR')">HR</button>
                        <button onclick="handleServiceClick('Show Projects')">Show Projects</button>
                        <button onclick="handleServiceClick('System Reports')">System Reports</button>
                        <button onclick="handleServiceClick('Create New')">Create New</button>
                        <button onclick="handleServiceClick('Dashboards')">Dashboards</button>
                    </div>
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="user-input" placeholder="Type a message..." />
                <button id="send-button">Send</button>
            </div>
            <div class="clear-history-container">
                <button id="clearHistory" class="clear-btn">Clear</button>
            </div>
        </div>

        <!-- The iframe container is hidden initially -->
        <div id="iframe-container">
            <iframe id="report-iframe" src="" frameborder="0"></iframe>
        </div>
    </div>

    <script>
      /* All your JavaScript exactly as before */
      const breadcrumbs = ["Main menu"];

      /*****************************************************************/
      function handleIframeResponse(responseMessage) {
            if (!responseMessage.startsWith("iframe::")) return false;

            const iframeUrl = responseMessage.split("iframe::")[1].trim();
            
            // Check if on mobile (screen width less than 768px)
            if (window.innerWidth <= 768) {
                // Open in new tab for mobile
                window.open(iframeUrl, '_blank');
                displayMessage("Opening in new tab...", 'bot-message');
                return true;
            }

            // Desktop behavior remains the same
            const iframeContainer = document.getElementById('iframe-container');
            const iframe = document.getElementById('report-iframe');

            // Update iframe source
            iframe.src = iframeUrl;

            // Show iframe container and adjust UI
            iframeContainer.style.display = 'block';
            document.getElementById('container').classList.add('chat-with-iframe');

            // Handle iframe loading errors
            iframe.onload = () => {
                displayMessage("Please find item in the next window", 'bot-message');
            };

            iframe.onerror = () => {
                console.error("Failed to load iframe.");
                displayMessage("The report failed to load. Please check the URL or try again.", 'bot-message');
                iframeContainer.style.display = 'none';
                document.getElementById('container').classList.remove('chat-with-iframe');
            };

            return true;
        }
      /*****************************************************************/
      function updateBreadcrumbs() {
          const breadcrumbsContainer = document.getElementById("breadcrumbs");
          breadcrumbsContainer.innerHTML = breadcrumbs.map((crumb, index) =>
              `<a href="#" onclick="navigateToBreadcrumb(${index})">${crumb}</a>`
          ).join(" > ");
      }

      function navigateToBreadcrumb(index) {
          breadcrumbs.splice(index + 1);
          updateBreadcrumbs();
          if (index === 0) {
              // Reset state before reloading
              fetch('/reset_state', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ session_id: 'default' })
              })
              .then(() => location.reload());
          } else {
              handleBreadcrumbNavigation(breadcrumbs[index]);
          }
      }

      function handleBreadcrumbNavigation(serviceName) {
          const chatBox = document.getElementById("chat-box");
          chatBox.innerHTML = "";
          displayMessage(`Navigated back to ${serviceName}`, 'bot-message');

          if (serviceName === "Main menu") {
              location.reload(); 
          } else {
              handleServiceClick(serviceName, true);
          }
      }

      function showLoading() {
          const chatBox = document.getElementById("chat-box");
          const loadingDiv = document.createElement("div");
          loadingDiv.className = "loading-container";
          loadingDiv.innerHTML = `
              <div class="loading-dots">
                  <div></div>
                  <div></div>
                  <div></div>
                  <div></div>
              </div>
          `;
          chatBox.appendChild(loadingDiv);
          loadingDiv.style.display = 'block';
          chatBox.scrollTop = chatBox.scrollHeight;
      }

      function hideLoading() {
          const loadingContainer = document.querySelector('.loading-container');
          if (loadingContainer) {
              loadingContainer.remove();
          }
      }

        function sendMessage() {
            const userMessage = document.getElementById("user-input").value.trim();
            if (!userMessage) return;

            const greeting = document.getElementById("greeting");
            if (greeting) greeting.remove();

            displayMessage(userMessage, 'user-message');
            document.getElementById("user-input").value = '';

            showLoading(); // Show loading animation

            fetch('/get_response', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMessage })
            })
            .then(response => response.json())
            .then(data => {
                const responseMessage = data.response;
                // Handle iframe or normal responses
                if (!handleIframeResponse(responseMessage)) {
                    displayMessage(responseMessage, 'bot-message');
                }
                hideLoading(); // Moved here to ensure it's called after displaying the message
            })
            .catch(error => {
                console.error("Error:", error);
                displayMessage("Sorry, there was an error. Please try again later.", 'bot-message');
                hideLoading(); // Also ensure it's called on error
            });
        }

        function handleServiceClick(serviceName, isBreadcrumbNavigation = false) {
            if (!isBreadcrumbNavigation) {
                breadcrumbs.push(serviceName);
                updateBreadcrumbs();
            }

            displayMessage(serviceName, 'user-message');
            const greeting = document.getElementById("greeting");
            if (greeting) greeting.remove();

            showLoading(); // Show loading animation

            fetch('/get_response', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: serviceName })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const responseMessage = data.response;

                    // Ensure responseMessage exists and is valid
                    if (!responseMessage) {
                        throw new Error("Empty response from server.");
                    }

                    // Handle iframe responses
                    if (!handleIframeResponse(responseMessage)) {
                        displayMessage(responseMessage, 'bot-message');
                    }

                    // Sub-service options logic
                    if (serviceName === "Accounting") {
                        displaySubServiceOptions(['Journal Entry', 'Payment Entry', 'Sales Invoice', 'Purchase Invoice'], "accounting-subservices");
                    } else if (serviceName === "Purchasing") {
                        displaySubServiceOptions(['Purchase Invoice'], "purchasing-subservices");
                    } else if (serviceName === "Selling") {
                        displaySubServiceOptions(['Sales Invoice', 'Quotation', 'Delivery Note'], "selling-subservices");
                    } else if (serviceName === "CRM") {
                        displaySubServiceOptions(['Lead', 'Opportunity', 'Customer'], "crm-subservices");
                    } else if (serviceName === "Payroll") {
                        displaySubServiceOptions(['Payroll Entry', 'Salary Slip'], "payroll-subservices");
                    } else if (serviceName === "Stock") {
                        displaySubServiceOptions(['Stock Entry', 'Stock Reconciliation'], "stock-subservices");
                    } else if (serviceName === "Manufacturing") {
                        displaySubServiceOptions(['BOM', 'Work Order', 'Job Card'], "manufacturing-subservices");
                    } else if (serviceName === "HR") {
                        displaySubServiceOptions(['employee checkin', 'employee'], "HR-subservices");
                    }else if (serviceName === "Show Projects") {
                        displaySubServiceOptions(['task', 'project', 'employee checkin', 'timesheet'], "Project-subservices");
                    } else if (serviceName === "System Reports") {
                        displaySubServiceOptions(['Purchasing & Selling Reports', 'Accounting Reports', 'HR & Payroll Reports', 'Stock Reports'], "system-reports-subservices");
                    } else if (serviceName === "Purchasing & Selling Reports") {
                        displaySubServiceOptions(['Purchase Analytics', 'Purchase Invoice Trends', 'Sales Analytics', 'Sales Invoice Trends'], "purchasing-selling-reports");
                    } else if (serviceName === "Accounting Reports") {
                        displaySubServiceOptions(['General Ledger', 'Balance Sheet', 'Profit and Loss Statement', 'Accounts Payable Summary', 'Accounts Receivable Summary', 'Gross Profit'], "accounting-reports");
                    } else if (serviceName === "HR & Payroll Reports") {
                        displaySubServiceOptions(['Employee Attendance', 'Salary Register'], "hr-payroll-reports");
                    } else if (serviceName === "Stock Reports") {
                        displaySubServiceOptions(['Stock Summary', 'Stock Ledger'], "stock-reports");
                    } else if (serviceName === "Create New") {
                        displaySubServiceOptions(['New Accounting', 'New Purchasing', 'New Selling', 'New CRM', 'New HR', 'New Payroll', 'New Stock', 'New Manufacturing', 'Other']);
                    } else if (serviceName === "New Accounting") {
                        displaySubServiceOptions(["New Journal Entry", "New Payment Entry", "New Sales Invoice", "New Purchase Invoice"]);
                    } else if (serviceName === "New Purchasing") {
                        displaySubServiceOptions([ "New Purchase Invoice", "New Purchase Receipt" ]);
                    } else if (serviceName === "New Selling") {
                        displaySubServiceOptions([ "New Sales Invoice", "New Sales Order",  "New Quotation", "New Supplier Quotation", "New Request for Quotation" ]);
                    } else if (serviceName === "New CRM") {
                        displaySubServiceOptions([ "New Lead", "New Opportunity", "New Customer" ]);
                    } else if (serviceName === "New HR") {
                        displaySubServiceOptions([ "New Leave Policy Assignment", "New Leave Application", "New Employee Attendance Tool", "New Upload Attendance", "New Employee"]);
                    } else if (serviceName === "New Payroll") {
                        displaySubServiceOptions(["New Payroll Entry", "New Salary Slip" ]);
                    } else if (serviceName === "New Stock") {
                        displaySubServiceOptions([ "New Stock Entry", "New Stock Reconciliation" ]);
                    } else if (serviceName === "New Manufacturing") {
                        displaySubServiceOptions(["New BOM", "New Work Order", "New Job Card"]);
                    } else if (serviceName === "Other") {
                        displaySubServiceOptions(["New Prospect",  "New Maintenance Schedule"]);
                    } else if (serviceName === "Dashboards") {
                        displaySubServiceOptions(['Accounts Dashboard', 'Buying Dashboard', 'Selling Dashboard', 'CRM Dashboard', 'Human Resources Dashboard', 'Payroll Dashboard', 'Stock Dashboard', 'Manufactring Dashboard', 'Project Dashboard']);
                    }
                    hideLoading(); // Moved here to ensure it's called after all processing is complete
                })
                .catch(error => {
                    console.error("Error in handleServiceClick:", error);
                    displayMessage("Sorry, there was an error(handel)", 'bot-message');
                    hideLoading();
                });
        }


      function displaySubServiceOptions(options, containerClass) {
          const chatBox = document.getElementById("chat-box");
          const subServiceOptions = document.createElement("div");
          subServiceOptions.className = `sub-service-buttons ${containerClass}`;
          subServiceOptions.innerHTML = `
              <p style="margin-bottom: 10px;">Please select one</p>
              <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; width: 100%;">
                  ${options.map(option => `<button onclick="handleServiceClick('${option}')" style="padding: 10px 15px; font-size: 14px; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; background-color: #e1f5fe; transition: background-color 0.3s;">${option}</button>`).join('')}
              </div>
          `;
          chatBox.appendChild(subServiceOptions);
          chatBox.scrollTop = chatBox.scrollHeight;
      }

      function displayMessage(message, className) {
          const chatBox = document.getElementById("chat-box");
          const iframeContainer = document.getElementById("iframe-container");
          const messageDiv = document.createElement("div");
          messageDiv.className = "message " + className;

          if (message.startsWith("iframe::")) {
              const url = message.split("iframe::")[1];
              
              // Remove existing iframe if any
              const existingIframe = iframeContainer.querySelector("iframe");
              if (existingIframe) existingIframe.remove();

              // Create iframe element
              const iframe = document.createElement("iframe");
              iframe.src = url;

              iframeContainer.appendChild(iframe);
              iframeContainer.style.display = "block";

              // Move chat box slightly to the left
              chatBox.style.marginRight = "10px";
          } else {
              // Convert markdown-style formatting
                  // Markdown-style formatting
               message = message
                  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
                  .replace(/### (.*?)(\n|$)/g, '<h3>$1</h3>') // Level 3 headers
                  .replace(/^## (.*?)(\n|$)/g, '<h3 class="bot-heading">$1</h3>') // Double hash for Level 2 headers
                  .replace(/^# (.*)$/gm, '<h2 class="bot-heading">$1</h2>') // Single hash for Level 1 headers
                  .replace(/^---$/gm, '<hr class="custom-divider">') // Triple dashes for horizontal rule
                  .replace(/(?:^|\n)- (.*?)(\n|$)/g, '<ul class="bot-list"><li>$1</li></ul>') // Bullet points
                  .replace(/\n/g, '<br>'); // Line breaks

            // Combine adjacent lists into one
            // message = message.replace(/<\/ul>\s*<ul class="bot-list">/g, '');

              messageDiv.innerHTML = message;
              chatBox.appendChild(messageDiv);
          }

          chatBox.scrollTop = chatBox.scrollHeight;
      }

      // Initialize breadcrumbs
      updateBreadcrumbs();

      document.getElementById("user-input").addEventListener("keydown", function (event) {
          if (event.key === "Enter") {
              sendMessage();
              event.preventDefault();
          }
      });

      document.getElementById("send-button").addEventListener("click", sendMessage);
      document.getElementById('clearHistory').addEventListener('click', function() {
          fetch('/clear_history', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  session_id: 'default'
              })
          })
          .then(response => response.json())
          .then(data => {
              // Clear the chat display
              const chatBox = document.getElementById('chat-box');
              chatBox.innerHTML = '';
              
              // Re-add the initial greeting
              const greeting = document.createElement('div');
              greeting.id = 'greeting';
              greeting.className = 'greeting-message';
              greeting.innerHTML = `
                  <p>Hi I am Ramzy! Please pick one of the following services or ask me any question:</p>
                  <div id="service-buttons">
                      <button onclick="handleServiceClick('Accounting')">Accounting</button>
                      <button onclick="handleServiceClick('Purchasing')">Purchasing</button>
                      <button onclick="handleServiceClick('Selling')">Selling</button>
                      <button onclick="handleServiceClick('CRM')">CRM</button>
                      <button onclick="handleServiceClick('Payroll')">Payroll</button>
                      <button onclick="handleServiceClick('Stock')">Stock</button>
                      <button onclick="handleServiceClick('Manufacturing')">Manufacturing</button>
                      <button onclick="handleServiceClick('HR')">HR</button>
                      <button onclick="handleServiceClick('Show Projects')">Show Projects</button>
                      <button onclick="handleServiceClick('System Reports')">System Reports</button>
                      <button onclick="handleServiceClick('Create New')">Create New</button>
                      <button onclick="handleServiceClick('Dashboards')">Dashboards</button>
                  </div>
              `;
              chatBox.appendChild(greeting);
              
              // Reset breadcrumbs
              breadcrumbs.length = 1;
              updateBreadcrumbs();
              
              // Hide iframe if visible
              document.getElementById('iframe-container').style.display = 'none';
              document.getElementById('container').classList.remove('chat-with-iframe');
          })
          .catch(error => console.error('Error:', error));
      });      

      // Add this new function for handling logout
      function handleLogout() {
          window.location.href = '/login';
      }

      // Fix for mobile viewport height
      function setVH() {
          let vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
      }

      window.addEventListener('load', setVH);
      window.addEventListener('resize', setVH);

      // Improve mobile keyboard handling
      document.getElementById('user-input').addEventListener('focus', function() {
          setTimeout(function() {
              window.scrollTo(0, 0);
              document.body.scrollTop = 0;
          }, 100);
      });
    </script>
</body>
</html>
